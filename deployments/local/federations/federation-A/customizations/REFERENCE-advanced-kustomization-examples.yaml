---
# ⚠️ REFERENCE ONLY - NOT CURRENTLY USED ⚠️
#
# This file demonstrates ADVANCED kustomization features that could be used
# as an ALTERNATIVE approach to the current overlay system.
#
# Status: UNTESTED - Provided as examples only
#
# Current Active Approach:
#   - overlays/exareme2/kustomization.yaml (simple resources list)
#   - overlays/exareme2/*.yaml (individual patch files)
#
# This Alternative Approach Shows:
#   - Strategic merge patches (more explicit)
#   - JSON 6902 patches (surgical changes)
#   - Common labels and annotations
#   - Image substitution
#   - Advanced patching techniques
#
# To Use This Approach (NOT RECOMMENDED unless you know what you're doing):
#   1. Replace overlays/exareme2/kustomization.yaml with this file's content
#   2. Move patch files to match the paths referenced here
#   3. Test thoroughly with: kubectl kustomize overlays/exareme2
#   4. Update exareme2-overlay-app.yaml to point to new structure
#
# ═══════════════════════════════════════════════════════════════════════

# Kustomization for federation-A exareme2 resource patches
# This applies strategic merge patches to the Kubernetes resources
# generated by the Helm chart
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: federation-a

# Strategic merge patches - will merge with existing resources
patchesStrategicMerge:
  - exareme2-deployment-patch.yaml
  - exareme2-worker-patch.yaml
  - exareme2-service-patch.yaml
  - exareme2-pvc-patch.yaml
  - exareme2-configmap-patch.yaml

# Additional resources not in the chart
resources:
  - exareme2-hpa.yaml

# Add labels to all resources
commonLabels:
  federation: federation-a
  environment: production
  managed-by: argocd

# Add annotations to all resources
commonAnnotations:
  federation.mip/id: "federation-a"
  federation.mip/tier: "high-performance"

# Patch specific images if needed (e.g., use internal registry)
# images:
#   - name: madgik/exareme2
#     newName: internal-registry.example.com/exareme2
#     newTag: 0.28.0-federation-a

# JSON patches for more surgical changes
patchesJson6902:
  # Add a custom init container to the exareme2 deployment
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: exareme2
    patch: |-
      - op: add
        path: /spec/template/spec/initContainers
        value:
          - name: federation-init
            image: busybox:1.35
            command: ['sh', '-c', 'echo "Initializing federation-a" && sleep 5']
      # Add security context
      - op: add
        path: /spec/template/spec/securityContext
        value:
          fsGroup: 1000
          runAsUser: 1000
          runAsNonRoot: true
      # Add a volumeMount for custom config
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: custom-config
          mountPath: /etc/exareme2/custom
      # Add the volume
      - op: add
        path: /spec/template/spec/volumes
        value:
          - name: custom-config
            configMap:
              name: exareme2-config

  # Patch the Service to add additional ports
  - target:
      version: v1
      kind: Service
      name: exareme2
    patch: |-
      - op: add
        path: /spec/ports/-
        value:
          name: metrics
          port: 9091
          targetPort: 9091
          protocol: TCP


